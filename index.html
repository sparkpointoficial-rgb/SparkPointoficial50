<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint - Referral System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.1/web3.min.js"></script>
    <style>
        :root {
            --primary: #00ff9d;
            --secondary: #00b8ff;
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --text: #ffffff;
            --gray: #888;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-connect { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: #000; }
        .btn-action { background: var(--primary); color: #000; width: 100%; margin-top: 10px; }
        .btn-copy { background: var(--secondary); color: #fff; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            padding: 10px 25px;
            background: #252525;
            cursor: pointer;
            border-radius: 8px;
            color: var(--gray);
        }
        .tab.active { background: var(--card-bg); color: var(--primary); border: 1px solid var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Статистика пользователя */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: left;
        }
        .stat-label { color: var(--gray); font-size: 0.85em; margin-bottom: 5px; }
        .stat-value { font-size: 1.1em; font-weight: bold; color: var(--primary); }

        /* Уровни */
        .level-section {
            background: var(--card-bg);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
        }
        .level-completed { border-color: var(--primary); background: rgba(0, 255, 157, 0.05); }
        .level-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }

        .circles-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            border: 2px solid #444;
            color: var(--gray);
        }
        .circle-filled {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.4);
        }

        input {
            width: 100%;
            padding: 14px;
            background: #111;
            border: 1px solid #444;
            border-radius: 10px;
            color: #fff;
            margin: 10px 0;
            box-sizing: border-box;
        }

        .ref-box {
            background: #111;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed var(--secondary);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2 style="margin:0;">SPARKPOINT SYSTEM</h2>
            <div id="walletAddr" style="font-size: 0.8em; color: var(--secondary); margin-top:5px;">Кошелек: Не подключен</div>
        </div>
        <button id="connectBtn" class="btn-connect">ПОДКЛЮЧИТЬ METAMASK</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="user">Личный кабинет</div>
        <div class="tab" data-tab="search">Поиск</div>
        <div class="tab" id="adminTabBtn" style="display:none;" data-tab="admin">Админ-панель</div>
    </div>

    <div id="userTab" class="tab-content active">
        <div id="refLinkArea" class="ref-box" style="display:none;">
            <label style="font-size:0.8em; color: var(--gray);">Ваша реферальная ссылка:</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="text" id="myRefLink" readonly style="margin:0;">
                <button class="btn-copy" id="copyBtn">Копировать</button>
            </div>
        </div>

        <div id="userStats" class="stats-grid">
            </div>

        <div id="registrationForm" class="level-section">
            <h3>Регистрация в системе</h3>
            <p style="color:var(--gray); font-size:0.9em;">Для вступления необходимо 0.05 BNB и адрес пригласителя.</p>
            <input type="text" id="referrerInput" placeholder="Адрес пригласителя (0x...)">
            <button class="btn-action" id="regBtn">ЗАРЕГИСТРИРОВАТЬСЯ</button>
        </div>

        <div id="levelsDisplay">
            </div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="level-section">
            <h3>Поиск участника</h3>
            <input type="text" id="searchInput" placeholder="Введите 0x адрес...">
            <button class="btn-action" style="background: var(--secondary); color:#fff;" id="searchBtn">Найти информацию</button>
            <div id="searchResult" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="adminTab" class="tab-content">
        <div class="level-section">
            <h3>Управление</h3>
            <button class="btn-action" id="withdrawBtn" style="background: #f1c40f;">Вывести комиссии контракта</button>
            <hr style="border:0.5px solid #333; margin:20px 0;">
            <h4>Ручное добавление</h4>
            <input type="text" id="admUserAddr" placeholder="Адрес нового">
            <input type="text" id="admRefAddr" placeholder="Адрес куратора">
            <button class="btn-action" id="admAddBtn">Добавить без оплаты</button>
        </div>
    </div>
</div>

<script>
    const CONTRACT_ADDRESS = '0xBE8228a29B4c986ca5A1bFA4b4762290f2fB24B3';
    const ABI = [{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_newAdmin","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"withdrawAdminFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"thresholds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"uint256","name":"referralsInLevel","type":"uint256"},{"internalType":"uint256","name":"totalDirectReferrals","type":"uint256"},{"internalType":"uint256","name":"registrationTime","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"}];

    const THRESHOLDS = [0, 2, 6, 14, 30, 62, 2, 6, 14, 30, 62];
    let web3, contract, account;

    window.addEventListener('load', async () => {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            
            const params = new URLSearchParams(window.location.search);
            if(params.get('ref')) document.getElementById('referrerInput').value = params.get('ref');
        }

        document.getElementById('connectBtn').onclick = connect;
        document.getElementById('copyBtn').onclick = copyLink;
        document.getElementById('regBtn').onclick = register;
        document.getElementById('searchBtn').onclick = search;
        document.getElementById('withdrawBtn').onclick = () => contract.methods.withdrawAdminFees().send({from: account});
        document.getElementById('admAddBtn').onclick = adminAdd;

        setupTabs();
    });

    async function connect() {
        const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
        account = accs[0];
        document.getElementById('walletAddr').innerText = "Кошелек: " + account;
        document.getElementById('connectBtn').innerText = "ПОДКЛЮЧЕНО";
        
        const link = window.location.origin + window.location.pathname + "?ref=" + account;
        document.getElementById('myRefLink').value = link;
        document.getElementById('refLinkArea').style.display = "block";

        checkAdmin();
        loadData();
    }

    async function loadData() {
        const u = await contract.methods.users(account).call();
        if (u.exists) {
            document.getElementById('registrationForm').style.display = 'none';
            renderStats(u);
            renderLevels(u.level, u.referralsInLevel);
        } else {
            document.getElementById('userStats').innerHTML = '<p>Вы еще не зарегистрированы.</p>';
        }
    }

    function renderStats(u) {
        const date = new Date(u.registrationTime * 1000).toLocaleDateString();
        document.getElementById('userStats').innerHTML = `
            <div class="stat-card"><div class="stat-label">Текущий Уровень</div><div class="stat-value">${u.level}</div></div>
            <div class="stat-card"><div class="stat-label">Личных рефералов</div><div class="stat-value">${u.totalDirectReferrals} / 2</div></div>
            <div class="stat-card"><div class="stat-label">Внутренний Баланс</div><div class="stat-value">${web3.utils.fromWei(u.internalBalance, 'ether')} BNB</div></div>
            <div class="stat-card"><div class="stat-label">Пригласитель (Referrer)</div><div class="stat-value" style="font-size:0.7em;">${u.referrer}</div></div>
            <div class="stat-card"><div class="stat-label">Дата регистрации</div><div class="stat-value">${date}</div></div>
            <div class="stat-card"><div class="stat-label">Рефералов на уровне</div><div class="stat-value">${u.referralsInLevel}</div></div>
        `;
    }

    function renderLevels(currLevel, refInLevel) {
        let html = '';
        for (let i = 1; i <= 10; i++) {
            const tr = THRESHOLDS[i];
            const isDone = i < currLevel;
            const isCurrent = i == currLevel;
            let activeCount = isDone ? tr : (isCurrent ? refInLevel : 0);

            let circles = '';
            for (let c = 0; c < tr; c++) {
                circles += `<div class="circle ${c < activeCount ? 'circle-filled' : ''}">${c < activeCount ? '✓' : c+1}</div>`;
            }

            html += `
                <div class="level-section ${isDone ? 'level-completed' : ''}">
                    <div class="level-header"><span>УРОВЕНЬ ${i}</span> <span>${isDone ? 'ЗАВЕРШЕН' : activeCount+'/'+tr}</span></div>
                    <div class="circles-container">${circles}</div>
                </div>`;
        }
        document.getElementById('levelsDisplay').innerHTML = html;
    }

    async function register() {
        const ref = document.getElementById('referrerInput').value || '0x0000000000000000000000000000000000000000';
        const price = await contract.methods.ENTRY_PRICE().call();
        await contract.methods.register(ref).send({ from: account, value: price });
        loadData();
    }

    async function search() {
        const val = document.getElementById('searchInput').value;
        const u = await contract.methods.users(val).call();
        const res = document.getElementById('searchResult');
        if(u.exists) {
            res.innerHTML = `<div class="stat-card"><b>Уровень:</b> ${u.level}<br><b>Рефералов:</b> ${u.totalDirectReferrals}<br><b>Куратор:</b> ${u.referrer}</div>`;
        } else { res.innerText = "Не найден."; }
    }

    async function copyLink() {
        const el = document.getElementById('myRefLink');
        el.select();
        document.execCommand('copy');
        const b = document.getElementById('copyBtn');
        b.innerText = "СКОПИРОВАНО!";
        setTimeout(() => b.innerText = "Копировать", 2000);
    }

    async function checkAdmin() {
        const adm = await contract.methods.admin().call();
        if(adm.toLowerCase() === account.toLowerCase()) document.getElementById('adminTabBtn').style.display = 'block';
    }

    async function adminAdd() {
        const u = document.getElementById('admUserAddr').value;
        const r = document.getElementById('admRefAddr').value;
        await contract.methods.adminAddUser(u, r).send({from: account});
    }

    function setupTabs() {
        document.querySelectorAll('.tab').forEach(t => {
            t.onclick = () => {
                document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                t.classList.add('active');
                document.getElementById(t.dataset.tab + 'Tab').classList.add('active');
            }
        });
    }
</script>

</body>
</html>

