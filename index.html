<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint | Реферальная Система</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.1/web3.min.js"></script>
    <style>
        :root {
            --primary: #00ff9d;
            --secondary: #00b8ff;
            --bg-dark: #0f0f0f;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --accent-red: #ff4b2b;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .app-container { width: 100%; max-width: 600px; }

        .glass-card {
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .header { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: -1px; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 13px;
        }

        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 255, 157, 0.4); }
        .btn-copied { background: var(--secondary) !important; color: white !important; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab {
            flex: 1; text-align: center; padding: 12px; background: #252525;
            border-radius: 10px; cursor: pointer; color: var(--text-dim); font-weight: 600;
        }
        .tab.active { background: var(--card-bg); color: var(--primary); border: 1px solid var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #252525; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-box label { display: block; color: var(--text-dim); font-size: 12px; margin-bottom: 5px; }
        .stat-box span { font-size: 18px; font-weight: 700; color: var(--secondary); }

        /* Копирование ссылки */
        .ref-link-box {
            display: flex; gap: 10px; background: #111; padding: 5px;
            border-radius: 12px; border: 1px dashed #444; margin-top: 10px;
        }
        .ref-link-box input { border: none !important; margin-bottom: 0 !important; background: transparent !important; flex: 1; font-size: 12px; }

        .level-row { background: var(--card-bg); border: 1px solid #333; border-radius: 15px; padding: 15px; margin-bottom: 12px; }
        .level-row.completed { border-color: var(--primary); }
        .level-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        
        .dots-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #333; border: 1px solid #444; }
        .dot.active { background: var(--primary); box-shadow: 0 0 8px var(--primary); border: none; }

        input {
            width: 100%; padding: 14px; background: #111; border: 1px solid #333;
            border-radius: 10px; color: #fff; margin-bottom: 15px; box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="glass-card header">
        <div>
            <div class="logo">SPARKPOINT</div>
            <div id="walletDisplay" style="font-size: 11px; color: var(--text-dim);">Кошелек не подключен</div>
        </div>
        <button class="btn btn-primary" id="connectBtn">Connect</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('main')">Кабинет</div>
        <div class="tab" onclick="showTab('search')">Поиск</div>
        <div class="tab" id="adminTabBtn" style="display:none;" onclick="showTab('admin')">Админ</div>
    </div>

    <div id="mainTab" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-box"><label>Уровень</label><span id="userLevel">-</span></div>
            <div class="stat-box"><label>Баланс BNB</label><span id="userBalance">0.00</span></div>
        </div>

        <div id="refLinkArea" class="glass-card" style="display:none;">
            <h4 style="margin:0 0 10px 0">Ваша партнерская ссылка</h4>
            <div class="ref-link-box">
                <input type="text" id="refLinkInput" readonly>
                <button class="btn btn-primary" id="copyBtn" onclick="copyRef()">Копировать</button>
            </div>
        </div>

        <div id="regArea" class="glass-card">
            <h3 style="margin-top:0">Регистрация</h3>
            <input type="text" id="refInput" placeholder="Адрес пригласителя (0x...)">
            <button class="btn btn-primary" style="width:100%" onclick="register()">Вступить (0.05 BNB)</button>
        </div>

        <div id="levelsContainer"></div>
    </div>

    <div id="searchTab" class="tab-content">
        <div class="glass-card">
            <h3>Просмотр структуры</h3>
            <input type="text" id="searchInput" placeholder="0x...">
            <button class="btn btn-primary" style="width:100%" onclick="searchUser()">Найти</button>
            <div id="searchResult" style="margin-top:20px"></div>
        </div>
    </div>

    <div id="adminTab" class="tab-content">
        <div class="glass-card">
            <h3>Панель управления</h3>
            <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="withdraw()">Вывести комиссию</button>
            <hr style="border: 0.5px solid #333; margin: 20px 0;">
            <h4>Добавить участника</h4>
            <input type="text" id="admUser" placeholder="Адрес нового">
            <input type="text" id="admRef" placeholder="Адрес пригласителя">
            <button class="btn btn-primary" style="width:100%" onclick="adminAdd()">Добавить в систему</button>
        </div>
    </div>
</div>

<script>
    const CONTRACT_ADDRESS = '0xBE8228a29B4c986ca5A1bFA4b4762290f2fB24B3';
    const ABI = [{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_newAdmin","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"withdrawAdminFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"thresholds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"uint256","name":"referralsInLevel","type":"uint256"},{"internalType":"uint256","name":"totalDirectReferrals","type":"uint256"},{"internalType":"uint256","name":"registrationTime","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"}];

    const LV_THRESHOLDS = [0, 2, 6, 14, 30, 62, 2, 6, 14, 30, 62];
    let web3, contract, userAccount;

    window.addEventListener('load', async () => {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('ref')) document.getElementById('refInput').value = urlParams.get('ref');
        }
        document.getElementById('connectBtn').onclick = connect;
    });

    async function connect() {
        const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accs[0];
        document.getElementById('walletDisplay').innerText = userAccount.slice(0,6) + '...' + userAccount.slice(-4);
        document.getElementById('connectBtn').innerText = 'Connected';
        
        // Показываем ссылку сразу после входа
        const link = window.location.origin + window.location.pathname + '?ref=' + userAccount;
        document.getElementById('refLinkInput').value = link;
        document.getElementById('refLinkArea').style.display = 'block';

        checkAdmin();
        loadUserData();
    }

    // Функция копирования
    async function copyRef() {
        const input = document.getElementById('refLinkInput');
        const btn = document.getElementById('copyBtn');
        
        try {
            await navigator.clipboard.writeText(input.value);
            const originalText = btn.innerText;
            btn.innerText = 'ГОТОВО!';
            btn.classList.add('btn-copied');
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('btn-copied');
            }, 2000);
        } catch (err) {
            console.error('Ошибка копирования', err);
        }
    }

    async function checkAdmin() {
        const adm = await contract.methods.admin().call();
        if (adm.toLowerCase() === userAccount.toLowerCase()) {
            document.getElementById('adminTabBtn').style.display = 'block';
        }
    }

    async function loadUserData() {
        const data = await contract.methods.users(userAccount).call();
        if (data.exists) {
            document.getElementById('regArea').style.display = 'none';
            document.getElementById('userLevel').innerText = data.level;
            document.getElementById('userBalance').innerText = web3.utils.fromWei(data.internalBalance, 'ether').slice(0,6);
            renderLevels(data.level, data.referralsInLevel);
        } else {
            renderEmptyLevels();
        }
    }

    function renderLevels(currentLevel, referralsInLevel) {
        let html = '';
        for (let i = 1; i <= 10; i++) {
            const threshold = LV_THRESHOLDS[i];
            const isCompleted = i < currentLevel;
            const isCurrent = i == currentLevel;
            let activeDots = isCompleted ? threshold : (isCurrent ? referralsInLevel : 0);
            let dots = '';
            for (let d = 0; d < threshold; d++) {
                dots += `<div class="dot ${d < activeDots ? 'active' : ''}"></div>`;
            }
            html += `
                <div class="level-row ${isCompleted ? 'completed' : ''}">
                    <div class="level-header"><b>Уровень ${i}</b><span>${isCompleted ? 'Завершен' : activeDots + '/' + threshold}</span></div>
                    <div class="dots-container">${dots}</div>
                </div>`;
        }
        document.getElementById('levelsContainer').innerHTML = html;
    }

    function renderEmptyLevels() {
        let html = '<p style="text-align:center; color:gray; margin-bottom:20px;">Пройдите регистрацию для доступа к уровням</p>';
        document.getElementById('levelsContainer').innerHTML = html;
    }

    async function register() {
        const ref = document.getElementById('refInput').value || '0x0000000000000000000000000000000000000000';
        const price = await contract.methods.ENTRY_PRICE().call();
        await contract.methods.register(ref).send({ from: userAccount, value: price });
        loadUserData();
    }

    async function searchUser() {
        const addr = document.getElementById('searchInput').value;
        if(!web3.utils.isAddress(addr)) return alert('Неверный адрес');
        const data = await contract.methods.users(addr).call();
        const res = document.getElementById('searchResult');
        if(data.exists) {
            res.innerHTML = `<div class="stat-box"><p>Уровень: ${data.level}</p><p>Рефералов: ${data.totalDirectReferrals}</p></div>`;
        } else { res.innerText = 'Пользователь не найден'; }
    }

    function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(name + 'Tab').classList.add('active');
        event.target.classList.add('active');
    }

    async function withdraw() { await contract.methods.withdrawAdminFees().send({ from: userAccount }); }
    async function adminAdd() {
        const u = document.getElementById('admUser').value;
        const r = document.getElementById('admRef').value;
        await contract.methods.adminAddUser(u, r).send({ from: userAccount });
    }
</script>

</body>
</html>

